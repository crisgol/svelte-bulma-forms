{#if horizontal}
<div class="field is-horizontal{addOn ? ' has-addons' : ''}">
  <div class="field-label is-normal">
{#if label}
    <FieldLabel {id} {size} {required} {label} />
{/if}
  </div>
  <div class="field-body">
    <div class="field">
{#if multiple}
      <MultiSelectControl 
        {name}
        {id}
        {state}
        {size}
        {required}
        {disabled}
        {value}
        bind:value="value"
        on:change="changeValue(event)"
      >
        <slot><!-- options are injected here --></slot>
      </MultiSelectControl>
{:else}
      <SelectControl 
        {name}
        {id}
        {iconLeft}
        {state}
        {size}
        {required}
        {disabled}
        {value}
        bind:value="value"
        on:change="changeValue(event)"
      >
        <slot><!-- options are injected here --></slot>
      </SelectControl>
{/if}
{#if addOn}
      <slot name="addOn"><!-- addon is injected here --></slot>
{/if}
{#if help}
      <p class="help{stateClass}">{help}</p>
{/if}
    </div>
  </div>
</div>

{:else}
<div class="field{addOn ? ' has-addons' : ''}">
{#if label}
  <FieldLabel {id} {size} {required} {label} />
{/if}
{#if multiple}
  <MultiSelectControl 
    {name}
    {id}
    {state}
    {size}
    {required}
    {disabled}
    {value}
    bind:value="value"
    on:change="changeValue(event)"
  >
    <slot><!-- options are injected here --></slot>
  </MultiSelectControl>
{:else}
  <SelectControl 
    {name}
    {id}
    {iconLeft}
    {state}
    {size}
    {required}
    {disabled}
    {value}
    bind:value="value"
    on:change="changeValue(event)"
  >
    <slot><!-- options are injected here --></slot>
  </SelectControl>
{/if}
{#if addOn}
  <slot name="addOn"><!-- addon is injected here --></slot>
{/if}
{#if help}
  <p class="help{stateClass}">{help}</p>
{/if}
</div>
{/if}

<script>
import uuid from 'random-uuid-v4'
import { validate, makeRules } from '../validation'

export default {
  components: {
    FieldLabel: './FieldLabel.html',
    SelectControl: '../controls/SelectControl.html',
    MultiSelectControl: '../controls/MultiSelectControl.html'
  },
  computed: {
    id: ({ name }) => `${name.toLowerCase()}${uuid()}`,
    stateClass: ({ state }) => state ? ` is-${state}` : '',
    validation: ({ _validate, validate, required }) => makeRules({ _validate, validate, required })
  },
  data () {
    return {
      name: '',
      value: null,
      help: '',
      iconLeft: null,
      addOn: null,
      horizontal: null,
      label: '',
      state: null,
      size: null,
      required: false,
      disabled: false,
      multiple: false,
      _validate: {},
      validate: {}
    }
  },
  methods: {
    changeValue (input) {
      const { required } = this.get()
      if (!required || validate(this, input)) {
        this.fire('change', input)
      }
    }
  },
  onstate ({ previous }) {
    if (Object.entries(this._slotted).length && !previous) {
      this.set({ addOn: true })
    }
  }
}
</script>

<style>

/* Correct label position with addons in vertical layout */
.field.has-addons {
  display: block;
}

.field.is-horizontal.has-addons,
.field.has-addons .has-addons {
  display: flex;
  justify-content: flex-start;
}

/* Correct label position with addons on mobile horizontal */
@media screen and (max-width: 768px) {
  .field.is-horizontal.has-addons {
    display: block;
  }

  .field.is-horizontal.has-addons .field.has-addons {
    display: flex;
    justify-content: flex-start;
  }
}

</style>
